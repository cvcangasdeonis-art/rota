<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Hoja Oficial · QR Lineup</title>
<meta name="theme-color" content="#1e3a8a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#1e3a8a; /* azul fuerte */
  --surface:#243c94;
  --line:#14202b;
  --text:#f9fafb;
  --muted:#cbd5e1;
  --accent:#facc15; /* amarillo */
  --accent-dark:#eab308;
}
*{box-sizing:border-box} html,body{margin:0;padding:0}
body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto;background:var(--bg);color:var(--text);line-height:1.6}
.container{width:100%;max-width:520px;margin:0 auto;padding:0.75rem}
h1,h2{margin:.2rem 0 .6rem} .muted{color:var(--muted)} .small{font-size:.9rem}
.site-header{position:sticky;top:0;background:var(--surface);border-bottom:1px solid rgba(255,255,255,.1)}
.header-grid{display:flex;align-items:center;gap:.75rem;justify-content:center;padding:.6rem 0}
.site-header img{height:40px;width:auto}
.site-header h1{color:#ffffff;font-weight:800;font-size:1.1rem;margin:0}
.card{background:var(--surface);border:1px solid var(--line);border-radius:1rem;padding:1rem;margin:1rem 0;box-shadow:0 4px 10px rgba(0,0,0,.4)}
.meta-grid{display:grid;grid-template-columns:1fr;gap:.8rem}
.meta-grid input, .meta-grid select{padding:.8rem;border:1px solid var(--line);border-radius:.6rem;background:#0a1117;color:var(--text)}
.side{display:flex;gap:1rem;border:1px dashed var(--line);padding:.6rem .8rem;border-radius:.6rem}
.pos-grid{display:flex;flex-direction:column;gap:.8rem;margin:1rem 0}
.pos-grid label{display:flex;justify-content:space-between;align-items:center;font-size:1rem}
.pos-grid input{
  flex:0 0 90px;
  text-align:center;
  font-size:1.4rem;
  padding:0.6rem;
  border:2px solid var(--accent-dark);
  border-radius:.6rem;
  background:var(--accent);
  color:#1e3a8a;
  font-weight:800;
}
.btn{border:none;background:#0e1620;color:var(--text);padding:.9rem;border-radius:.8rem;cursor:pointer;width:100%}
.btn.small{padding:.6rem}
.btn-primary{background:var(--accent);color:#1e3a8a;font-weight:800}
.row{display:flex;flex-direction:column;gap:.6rem;margin-top:.6rem}
#qr{width:280px;min-height:280px;background:#0a1117;border:1px dashed var(--line);display:grid;place-items:center;border-radius:.6rem;margin:0 auto;padding:.5rem}
.payload textarea{width:100%;padding:.8rem;border:1px solid var(--line);border-radius:.8rem;background:#0a1117;color:var(--text)}
.site-footer{padding:1rem 0;border-top:1px solid var(--line)} .footer-grid{display:flex;align-items:center;justify-content:space-between}
code{background:#0a1117;padding:.1rem .3rem;border-radius:.3rem;border:1px solid var(--line)}
</style>

<!-- CDN principal de la librería QR -->
<script id="qrcode-cdn-1" src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js" defer></script>
<!-- CDN de respaldo: se inyecta si el primero falla -->
<script>
window.__qrReady = false;
window.addEventListener('load', function(){
  // Si tras un breve tiempo no existe window.QRCode, cargamos un segundo CDN
  setTimeout(function(){
    if(!window.QRCode){
      var s = document.createElement('script');
      s.src = 'https://unpkg.com/qrcode/build/qrcode.min.js';
      s.defer = true;
      s.onload = function(){ window.__qrReady = true; };
      document.head.appendChild(s);
    } else {
      window.__qrReady = true;
    }
  }, 150);
});
</script>
</head>
<body>
<header class="site-header">
  <div class="container header-grid">
    <!-- Sube tu logo a assets/img/logo.png o cambia la ruta -->
    <img src="assets/img/logo.png" alt="Logo del club" onerror="this.style.display='none'">
    <h1>Hoja Oficial · QR</h1>
  </div>
</header>

<main class="container">
  <section class="card">
    <form id="meta" class="meta-grid" onsubmit="return false;">
      <label>Código equipo
        <input type="text" id="equipo" placeholder="CANGAS" required>
      </label>
      <fieldset class="side">
        <legend>Equipo</legend>
        <label><input type="radio" name="side" value="A" checked> A</label>
        <label><input type="radio" name="side" value="B"> B</label>
      </fieldset>
      <label>Set
        <select id="set">
          <option value="1">1</option><option value="2">2</option>
          <option value="3">3</option><option value="4">4</option><option value="5">5</option>
        </select>
      </label>
    </form>
  </section>

  <section class="card">
    <h2>Posiciones I – VI</h2>
    <div class="pos-grid">
      <label>I<input inputmode="numeric" pattern="\\d*" maxlength="3" id="p1"></label>
      <label>II<input inputmode="numeric" pattern="\\d*" maxlength="3" id="p2"></label>
      <label>III<input inputmode="numeric" pattern="\\d*" maxlength="3" id="p3"></label>
      <label>IV<input inputmode="numeric" pattern="\\d*" maxlength="3" id="p4"></label>
      <label>V<input inputmode="numeric" pattern="\\d*" maxlength="3" id="p5"></label>
      <label>VI<input inputmode="numeric" pattern="\\d*" maxlength="3" id="p6"></label>
    </div>
    <div class="row">
      <button id="rot-mas" class="btn">Rotar (+)</button>
      <button id="rot-menos" class="btn">Rotar (–)</button>
      <button id="btn-generar" class="btn btn-primary">Generar QR</button>
    </div>
  </section>

  <section class="card">
    <h2>QR y Payload</h2>
    <div id="qr"></div>
    <label>Cadena generada
      <textarea id="payload" rows="6" readonly></textarea>
    </label>
    <div class="row">
      <button id="btn-png" class="btn">Descargar PNG</button>
    </div>
  </section>
</main>

<footer class="site-footer">
  <div class="container footer-grid">
    <p>© <span id="year"></span> Hoja Oficial QR</p>
  </div>
</footer>

<script>
/* Utilidad DOM */
const $=(s,r=document)=>r.querySelector(s); const $$=(s,r=document)=>[...r.querySelectorAll(s)];
const yearEl=$('#year'); if(yearEl) yearEl.textContent=new Date().getFullYear();

/* Lectura de campos */
function getSide(){return document.querySelector('input[name="side"]:checked').value;}
function getPositions(){
  const v=[$('#p1').value,$('#p2').value,$('#p3').value,$('#p4').value,$('#p5').value,$('#p6').value].map(x=>x.trim());
  const set=new Set(v.filter(x=>x!==''));
  if(set.size!==v.filter(x=>x!=='').length) throw new Error('No puedes repetir dorsales.');
  if(v.some(x=>x==='')) throw new Error('Completa las 6 posiciones.'); 
  return v;
}
function setPositions(vals){[$('#p1'),$('#p2'),$('#p3'),$('#p4'),$('#p5'),$('#p6')].forEach((el,i)=>el.value=vals[i]??'');}

/* Rotaciones */
function rotatePlus(){const v=getPositions(); setPositions([v[5],v[0],v[1],v[2],v[3],v[4]]);}
function rotateMinus(){const v=getPositions(); setPositions([v[1],v[2],v[3],v[4],v[5],v[0]]);}

/* Payload con el formato oficial que me diste */
function buildPayload(){
  const equipo=$('#equipo').value.trim(); if(!equipo) throw new Error('Introduce el código de equipo.');
  const side=getSide(); const set=$('#set').value; const v=getPositions();
  const zones={ZN1:v[0],ZN2:v[1],ZN3:v[2],ZN4:v[3],ZN5:v[4],ZN6:v[5]};
  return JSON.stringify([equipo,side,JSON.stringify(zones),set]);
}

/* Generación QR robusta (con fallback) */
function renderQR(text){
  const el=$('#qr'); el.innerHTML='';
  // Si la librería QRCode (con Q mayúscula) está disponible, usamos canvas
  function drawWithLib(){
    const canvas=document.createElement('canvas');
    try{
      window.QRCode.toCanvas(canvas,text,{width:280,margin:1},e=>{
        if(e){ console.error(e); drawFallback(); }
      });
      el.appendChild(canvas);
    }catch(err){
      console.warn('Fallo usando QRCode lib, uso fallback IMG', err);
      drawFallback();
    }
  }
  // Fallback universal: imagen desde servicio público (sin libs)
  function drawFallback(){
    const img=document.createElement('img');
    img.alt='QR'; img.width=280; img.height=280;
    img.src='https://api.qrserver.com/v1/create-qr-code/?size=280x280&data='+encodeURIComponent(text);
    el.appendChild(img);
  }
  // Espera breve a que la librería esté lista; si no, fallback
  let tries=0;
  (function waitForLib(){
    if(window.QRCode){ drawWithLib(); }
    else if(tries++<20){ setTimeout(waitForLib,100); }
    else { drawFallback(); }
  })();
}

/* Descargar PNG (funciona cuando hay canvas; si hubo fallback IMG, baja la imagen) */
function downloadPNG(){
  const canvas=$('#qr canvas');
  if(canvas){
    const a=document.createElement('a');
    a.href=canvas.toDataURL('image/png');
    a.download='hoja-oficial-qr.png';
    a.click();
  }else{
    const img=$('#qr img');
    if(!img){ alert('Genera el QR primero.'); return; }
    // Abre la imagen en nueva pestaña para “Guardar imagen”
    window.open(img.src, '_blank');
  }
}

/* Generar */
function generate(){ 
  try{ const payload=buildPayload(); $('#payload').value=payload; renderQR(payload); }
  catch(e){ alert(e.message); }
}

/* Eventos */
$('#rot-mas').addEventListener('click',e=>{e.preventDefault(); try{rotatePlus();}catch(err){alert(err.message);}});
$('#rot-menos').addEventListener('click',e=>{e.preventDefault(); try{rotateMinus();}catch(err){alert(err.message);}});
$('#btn-generar').addEventListener('click',e=>{e.preventDefault(); generate();});
$('#btn-png').addEventListener('click',e=>{e.preventDefault(); downloadPNG();});
</script>
</body>
</html>
