<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Hoja Oficial · QR Lineup</title>
<meta name="theme-color" content="#1e3a8a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0b1e6d; --surface:#132a7a; --surface2:#0f256d; --line:rgba(255,255,255,.15);
  --text:#f8fafc; --muted:#cbd5e1; --accent:#facc15; --accent-dark:#eab308;
}
*{box-sizing:border-box} html,body{margin:0;padding:0}
body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto;background:linear-gradient(180deg,#0b1e6d 0%, #0a1a5a 100%);color:var(--text);line-height:1.6}
.container{width:100%;max-width:560px;margin:0 auto;padding:0.75rem}
h1,h2{margin:.2rem 0 .6rem}
.small{font-size:.9rem;color:var(--muted)}
.site-header{background:linear-gradient(90deg,#0f1f73 0%, #1e3a8a 50%, #0f1f73 100%);border-bottom:1px solid var(--line);padding:1.25rem 0;text-align:center}
.site-header img{max-width:260px;width:80%;height:auto;display:block;margin:0 auto;filter:drop-shadow(0 6px 16px rgba(0,0,0,.35))}
.card{background:linear-gradient(180deg,var(--surface) 0%, var(--surface2) 100%);border:1px solid var(--line);border-radius:1rem;padding:1rem;margin:1rem 0;box-shadow:0 8px 20px rgba(0,0,0,.35)}
.card h2{font-size:1.05rem;margin-top:0}
.meta-grid{display:grid;grid-template-columns:1fr;gap:.8rem}
.meta-grid input, .meta-grid select{padding:.9rem;border:1px solid var(--line);border-radius:.6rem;background:#0a1117;color:var(--text)}
.side{display:flex;gap:1rem;border:1px dashed var(--line);padding:.6rem .8rem;border-radius:.6rem}
.pos-grid{display:flex;flex-direction:column;gap:.8rem;margin:1rem 0}
.pos-row{display:grid;grid-template-columns:48px 1fr;gap:.6rem;align-items:center}
.pos-row input{
  text-align:center;font-size:1.35rem;padding:.6rem;border:2px solid var(--accent-dark);
  border-radius:.6rem;background:var(--accent);color:#1e3a8a;font-weight:800
}
.row{display:flex;flex-direction:column;gap:.6rem;margin-top:.6rem}
.btn{border:none;background:linear-gradient(180deg,#101826,#0b1320);color:var(--text);padding:1rem;border-radius:.9rem;cursor:pointer;width:100%;box-shadow:0 6px 14px rgba(0,0,0,.35);transition:transform .06s ease, box-shadow .2s ease}
.btn:hover{transform:translateY(-1px); box-shadow:0 10px 20px rgba(0,0,0,.4)}
.btn-primary{background:linear-gradient(90deg,var(--accent),#ffd84d); color:#1b1b00; font-weight:800}
.btn-danger{background:linear-gradient(180deg,#2a0f14,#1b0a0d)}
.btn-ok{background:linear-gradient(180deg,#11361f,#0b2416)}
#qr{width:300px;min-height:300px;background:#0a1117;border:1px dashed var(--line);display:grid;place-items:center;border-radius:.8rem;margin:0 auto;padding:.6rem}
.toast{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);background:#0b2416;border:1px solid rgba(34,197,94,.35);color:#d1fae5;padding:.7rem 1rem;border-radius:.7rem;box-shadow:0 8px 18px rgba(0,0,0,.35);opacity:0;pointer-events:none;transition:opacity .25s ease}
.toast.show{opacity:1}
.scan-box{border:1px dashed var(--line);border-radius:.8rem;padding:.6rem;background:#0a1117}
.scan-result{background:#0e1620;border:1px solid var(--line);border-radius:.6rem;padding:.6rem;margin-top:.6rem;font-family:ui-monospace, SFMono-Regular, Menlo, monospace}
.site-footer{padding:1rem 0;border-top:1px solid var(--line)}
.footer-grid{display:flex;align-items:center;justify-content:center;color:var(--muted);font-size:.85rem}
</style>
<script id="qrcode-cdn-1" src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js" defer></script>
<script>
window.addEventListener('load', function(){
  setTimeout(function(){
    if(!window.QRCode){
      var s=document.createElement('script'); s.src='https://unpkg.com/qrcode/build/qrcode.min.js'; s.defer=true; document.head.appendChild(s);
    }
  },150);
});
</script>
<script src="https://unpkg.com/html5-qrcode" defer></script>
</head>
<body>
<header class="site-header">
  <img src="dani.png" alt="Portada">
</header>

<main class="container">
  <section class="card">
    <h2>Datos del set</h2>
    <form id="meta" class="meta-grid" onsubmit="return false;">
      <label>Código equipo
        <input type="text" id="equipo" placeholder="CANGAS" required>
      </label>
      <fieldset class="side">
        <legend>Equipo</legend>
        <label><input type="radio" name="side" value="A" checked> A</label>
        <label><input type="radio" name="side" value="B"> B</label>
      </fieldset>
      <label>Set
        <select id="set">
          <option value="1">1</option><option value="2">2</option>
          <option value="3">3</option><option value="4">4</option><option value="5">5</option>
        </select>
      </label>
    </form>
    <div class="row">
      <button id="btn-reset" class="btn btn-danger">Borrar todo</button>
    </div>
  </section>

  <section class="card">
    <h2>Posiciones I – VI</h2>
    <p class="small">Introduce dorsales (solo números). (+) rota ZN1→ZN6.</p>
    <div class="pos-grid">
      <div class="pos-row"><div class="lbl">I</div><input id="p1" type="tel" inputmode="numeric" pattern="[0-9]*" maxlength="3"></div>
      <div class="pos-row"><div class="lbl">II</div><input id="p2" type="tel" inputmode="numeric" pattern="[0-9]*" maxlength="3"></div>
      <div class="pos-row"><div class="lbl">III</div><input id="p3" type="tel" inputmode="numeric" pattern="[0-9]*" maxlength="3"></div>
      <div class="pos-row"><div class="lbl">IV</div><input id="p4" type="tel" inputmode="numeric" pattern="[0-9]*" maxlength="3"></div>
      <div class="pos-row"><div class="lbl">V</div><input id="p5" type="tel" inputmode="numeric" pattern="[0-9]*" maxlength="3"></div>
      <div class="pos-row"><div class="lbl">VI</div><input id="p6" type="tel" inputmode="numeric" pattern="[0-9]*" maxlength="3"></div>
    </div>
    <div class="row">
      <button id="rot-mas" class="btn">Rotar (+)</button>
      <button id="rot-menos" class="btn">Rotar (–)</button>
      <button id="btn-generar" class="btn btn-primary">Generar QR</button>
    </div>
  </section>

  <section class="card">
    <h2>QR</h2>
    <div id="qr"></div>
    <div class="row">
      <button id="btn-png" class="btn btn-ok">Descargar PNG</button>
    </div>
  </section>

  <section class="card">
    <h2>Escanear QR (comprobar hoja)</h2>
    <div class="scan-box">
      <div id="reader" style="width:100%;max-width:520px;"></div>
      <div class="row" style="margin-top:.6rem">
        <button id="scan-start" class="btn">Iniciar cámara</button>
        <button id="scan-stop" class="btn">Detener cámara</button>
      </div>
      <div id="scan-out" class="scan-result" style="display:none"></div>
    </div>
  </section>
</main>

<footer class="site-footer">
  <div class="container footer-grid">
    <p>© <span id="year"></span> Hoja Oficial QR</p>
  </div>
</footer>

<div id="toast" class="toast">✅ QR generado</div>

<script>
const $=s=>document.querySelector(s);const $$=s=>[...document.querySelectorAll(s)];
const yearEl=$('#year');if(yearEl) yearEl.textContent=new Date().getFullYear();
function onlyDigits(e){e.target.value=e.target.value.replace(/\D+/g,'').slice(0,3);}
['#p1','#p2','#p3','#p4','#p5','#p6'].forEach(id=>{const el=$(id);el.addEventListener('input',onlyDigits);el.addEventListener('blur',onlyDigits);});
function getSide(){return document.querySelector('input[name="side"]:checked').value;}
function getPositions(){const v=[$('#p1').value,$('#p2').value,$('#p3').value,$('#p4').value,$('#p5').value,$('#p6').value].map(x=>x.trim());const set=new Set(v.filter(x=>x!==''));if(set.size!==v.filter(x=>x!=='').length) throw new Error('No puedes repetir dorsales.');if(v.some(x=>x==='')) throw new Error('Completa las 6 posiciones.');return v;}
function setPositions(vals){[$('#p1'),$('#p2'),$('#p3'),$('#p4'),$('#p5'),$('#p6')].forEach((el,i)=>el.value=vals[i]??'');}
function rotatePlus(){const v=getPositions();setPositions([v[1],v[2],v[3],v[4],v[5],v[0]]);}
function rotateMinus(){const v=getPositions();setPositions([v[5],v[0],v[1],v[2],v[3],v[4]]);}
function resetAll(){$('#equipo').value='';$$('input[name="side"]').forEach(r=>r.checked=(r.value==='A'));$('#set').value='1';setPositions(['','','','','','']);$('#qr').innerHTML='';toast('Campos borrados');}
function buildPayload(){const equipo=$('#equipo').value.trim();if(!equipo) throw new Error('Introduce el código de equipo.');const side=getSide();const set=$('#set').value;const v=getPositions();const zones={ZN1:v[0],ZN2:v[1],ZN3:v[2],ZN4:v[3],ZN5:v[4],ZN6:v[5]};return JSON.stringify([equipo,side,JSON.stringify(zones),set]);}
function renderQR(text){const el=$('#qr');el.innerHTML='';function drawWithLib(){const canvas=document.createElement('canvas');try{window.QRCode.toCanvas(canvas,text,{width:300,margin:1},e=>{if(e){console.error(e);drawFallback();}});el.appendChild(canvas);}catch(err){drawFallback();}}function drawFallback(){const img=document.createElement('img');img.alt='QR';img.width=300;img.height=300;img.src='https://api.qrserver.com/v1/create-qr-code/?size=300x300&data='+encodeURIComponent(text);el.appendChild(img);}let tries=0;(function waitForLib(){if(window.QRCode){drawWithLib();}else if(tries++<20){setTimeout(waitForLib,100);}else{drawFallback();}})();}
function downloadPNG(){const canvas=document.querySelector('#qr canvas');if(canvas){const a=document.createElement('a');a.href=canvas.toDataURL('image/png');a.download='hoja-oficial-qr.png';a.click();}else{const img=document.querySelector('#qr img');if(img){window.open(img.src,'_blank');}else{alert('Genera el QR primero.');}}}
function toast(msg){const t=$('#toast');t.textContent='✅ '+msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),1800);}
function generate(){try{renderQR(buildPayload());toast('QR generado');}catch(e){alert(e.message);}}
let html5QrcodeObj=null;
async function startScan(){
  if(!window.Html5Qrcode){alert('Cargando cámara… inténtalo en 1–2 s.');return;}
  if(html5QrcodeObj){return;}
  html5QrcodeObj=new Html5Qrcode("reader");
  try{
    await html5QrcodeObj.start(
      { facingMode:"environment" },
      { fps:10, qrbox:{width:250,height:250} },
      onScanSuccess, ()=>{}
    );
  }catch(e){
    try{
      const cameras=await Html5Qrcode.getCameras();
      const camId=cameras && cameras.length ? cameras[0].id:null;
      if(!camId){alert('No se encontró cámara.');html5QrcodeObj=null;return;}
      await html5QrcodeObj.start(camId,{ fps:10,qrbox:{width:250,height:250} },onScanSuccess,()=>{});
    }catch(err){alert('No se pudo iniciar la cámara: '+err);html5QrcodeObj=null;}
  }
}
function stopScan(){if(html5QrcodeObj){html5QrcodeObj.stop().then(()=>{html5QrcodeObj.clear();html5QrcodeObj=null;}).catch(()=>{});}}
function onScanSuccess(decodedText){let out=$('#scan-out');out.style.display='block';try{const arr=JSON.parse(decodedText);const equipo=arr[0],side=arr[1],set=arr[3];const zones=JSON.parse(arr[2]);out.innerHTML=`<strong>Equipo:</strong> ${equipo}<br><strong>Lado:</strong> ${side}<br><strong>Set:</strong> ${set}<br><strong>ZN1..ZN6:</strong> ${zones.ZN1}, ${zones.ZN2}, ${zones.ZN3}, ${zones.ZN4}, ${zones.ZN5}, ${zones.ZN6}`;}catch(e){out.textContent='Formato no reconocido: '+decodedText;}}
$('#rot-mas').addEventListener('click',e=>{e.preventDefault();try{rotatePlus();}catch(err){alert(err.message);}});
$('#rot-menos').addEventListener('click',e=>{e.preventDefault();try{rotateMinus();}catch(err){alert(err.message);}});
$('#btn-generar').addEventListener('click',e=>{e.preventDefault();generate();});
$('#btn-png').addEventListener('click',e=>{e.preventDefault();downloadPNG();});
$('#btn-reset').addEventListener('click',e=>{e.preventDefault();resetAll();});
$('#scan-start').addEventListener('click',e=>{e.preventDefault();startScan();});
$('#scan-stop').addEventListener('click',e=>{e.preventDefault();stopScan();});
</script>
</body>
</html>
